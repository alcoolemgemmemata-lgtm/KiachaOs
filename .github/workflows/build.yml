name: KiachaOS Build Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build KiachaOS Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cpio \
            gzip \
            dosfstools \
            mtools \
            xorriso \
            grub-pc-bin \
            grub-efi-amd64-bin \
            qemu-utils

      - name: Validate directory structure
        run: |
          ./scripts/check-structure.sh

      - name: Build initramfs
        run: |
          cd os-image
          chmod +x build-initramfs.sh
          ./build-initramfs.sh

      - name: Build efiboot image
        run: |
          cd os-image
          chmod +x build-efiboot.sh
          ./build-efiboot.sh || echo "Warning: efiboot.img build skipped (may require elevated permissions)"

      - name: Build kiachaos disk image
        run: |
          cd os-image
          chmod +x build-kiacha-img.sh
          ./build-kiacha-img.sh

      - name: Build ISO
        run: |
          cd os-image
          chmod +x build-iso.sh
          ./build-iso.sh || echo "Warning: ISO build skipped"

      - name: Verify artifacts
        run: |
          ls -lah os-image/initramfs.img os-image/kiachaos.img 2>/dev/null || true
          file os-image/initramfs.img os-image/kiachaos.img 2>/dev/null || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: kiachaos-build
          path: |
            os-image/initramfs.img
            os-image/efiboot.img
            os-image/kiachaos.img
            os-image/kiachaos.iso
          retention-days: 30

      - name: Upload to Release (on tags)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            os-image/initramfs.img
            os-image/efiboot.img
            os-image/kiachaos.img
            os-image/kiachaos.iso
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Status Summary
        if: always()
        run: |
          echo "=== KiachaOS Build Summary ==="
          echo "Artifacts location: os-image/"
          ls -lh os-image/*.img os-image/*.iso 2>/dev/null || echo "Some artifacts not generated"
          echo "Check Actions tab for full logs"
